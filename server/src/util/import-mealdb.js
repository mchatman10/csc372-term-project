import 'dotenv/config'
import { query } from '../db.js'
async function ensureCategory(name) { const { rows } = await query('SELECT id FROM categories WHERE name=$1', [name]); if (rows[0]) return rows[0].id; const r = await query('INSERT INTO categories (name) VALUES ($1) RETURNING id', [name]); return r.rows[0].id }
async function importCategory(name) { console.log('Importing', name); const catId = await ensureCategory(name); const r = await fetch(`https://www.themealdb.com/api/json/v1/1/filter.php?c=${encodeURIComponent(name)}`); const data = await r.json(); for (const m of data.meals || []) { try { const full = await fetch(`https://www.themealdb.com/api/json/v1/1/lookup.php?i=${m.idMeal}`); const detailed = (await full.json()).meals?.[0]; if (!detailed) continue; const ingredients = Object.keys(detailed).filter(k => k.startsWith('strIngredient') && detailed[k]).map(k => detailed[k]); const steps = (detailed.strInstructions || '').split('\n').filter(Boolean); const ins = await query('INSERT INTO recipes (user_id,title,description,ingredients,steps,image_url) VALUES (NULL,$1,$2,$3,$4,$5) ON CONFLICT DO NOTHING RETURNING id', [detailed.strMeal, detailed.strInstructions?.slice(0, 200) || 'A recipe from TheMealDB.', ingredients, steps, detailed.strMealThumb]); const recipeId = ins.rows?.[0]?.id; if (recipeId) { await query('INSERT INTO recipe_categories (recipe_id,category_id) VALUES ($1,$2) ON CONFLICT DO NOTHING', [recipeId, catId]) } console.log('  added:', detailed.strMeal) } catch (e) { console.log('  skip', m.idMeal) } } }
async function main() { for (const c of ['Breakfast', 'Lunch', 'Dinner']) await importCategory(c); console.log('Import complete.'); process.exit() } main()